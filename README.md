一、	程序架构
程序分为服务器和客户端两部分，服务器负责在21端口创建socket连接和监听端口，客户端用来与服务器建立TCP连接。服务器支持多客户端访问，所以每接收一个访问，在登陆验证通过后，将连接后的具体功能交给子进程处理。以上是控制进程连接方式，如下图所示
 ![image](https://user-images.githubusercontent.com/95112515/183558152-857b9ec1-d6da-437b-9ea3-b5032a17d336.png)
接下来子进程处理客户端发来的命令，当遇到需文件传输时，子进程建立新的连接来完成文件传输。传输的方式有两种，主动传输和被动传输。主动传输通过客户端将自己的监听端口发给服务器，客户端建立socket监听，服务器通过20端口主动连接客户端的方式建立连接。被动传输则是服务器随机生成一个大于1024的端口号，发给客户端，之后服务器监听这个端口，客户端随机一个端口来连接服务器。两种方式都是在数据传输完成后关闭连接。
二、	实现方法
1、	登录验证
用户从客户端连接后，首先要输入“ftp ip 端口”这种格式的命令，之后发送给服务器连接，用户还需输入“user 用户名”和“pass 密码”，密码正确即可登录，其中密码在传输过程中采用密文，加密方式为每个字符的ASCII加一。登录后会选择采用主动还是被动传输方式，若是主动，则客户端发给服务器自己的监听端口号，被动模式相反。
2、	客户端从服务器下载文件
下载文件需要客户端输入“get 文件名”命令，服务器收到后首先查找该文件是否存在，若文件不存在返回425，并不创建数据连接。若文件存在，且采用主动模式，服务器会先sleep一秒，同时客户端创建socket监听，之后服务器连接客户端，获得数据传输的套接字，并每次从服务器read()读取1kB数据，调用send函数通过tcp发送给客户端，客户端每次接收1kB，并通过write写入创建好的文件中。循环结束后文件下载完成，服务器返回426回应码，表示连接关闭，传输终止。若是被动连接，由服务器创建连接，客户端sleep一秒，之后连接服务器，其他操作同主动连接。
3、	客户端向服务器上传文件
上传文件需要客户端输入“put 文件名”命令，客户端首先查找该文件是否存在，若文件不存在发送425，并不创建数据连接。若文件存在，且采用主动模式，服务器会先sleep一秒，同时客户端创建socket监听，之后服务器连接客户端，获得数据传输的套接字，并获得125回应码，表示数据链接打开，传输开始。每次从客户端读取1kB数据，调用send函数通过tcp发送给服务器，服务器调用recv函数每次接收1kB，并通过write写入创建好的文件中。循环结束后文件上传完成，服务器返回426回应码，表示连接关闭，传输终止。若是被动连接，由服务器创建连接，客户端sleep一秒，之后连接服务器，其他操作同主动连接。
4、	远程文件目录的显示和操作
输入命令pwd可显示服务器当前所在的路径，通过调用getpwd()函数返回的字符串来确定，并send给客户端并输出。输入命令dir可显示服务器当前目录的子目录和文件列表，首先通过getpwd找到当前路径位置，然后调用opendir打开该路径下的文件夹，接着用readdir循环读取文件夹下的每个文件，并写入字符串中，之后发送客户端，输出。输入命令“cd 文件夹”可以进入该文件夹，前提是文件夹存在，若不存在会返回该文件夹不存在。通过chdir()函数改变远程文件所在目录，之后可通过pwd和dir验证。通过help()命令可以获取服务器提供的所有命令信息
5、	符合rfc959标准
通过查阅rfc959文档，获知控制编号。上述put和get方法返回的回应吗均来源于rfc959文档，user、pass、ftp的命令也来源于rfc959标准。本程序在命令格式和回应码两方面符合了rfc959标准。
6、	主动被动传输方式
主动传输
FTP客户端从任意的非特殊的端口（N >1024）连入到FTP服务器的命令端口——21端口。然后客户端在N+1端口监听，并且通过该N+1端口发送PORT命令给FTP服务器，接着服务器会从它自己的数据端口（20）连接到客户端指定的数据端口（N+1）。
 ![image](https://user-images.githubusercontent.com/95112515/183558206-c1715450-c19a-45d0-9755-559f1b227674.png)

被动传输
当开启一个FTP连接时，客户端随机打开一个大于1024的本地端口N向服务器的21号端口发起连接，同时会开启N+1号端口。然后向服务器提交 PASV命令，通知服务器自己处于被动模式。那么服务器收到命令后就会开启一个任意的非特权端口（P > 1024）监听，并发送PORT P命令给客户端通知自己的数据端口是P。然后客户端通过本地端口N+1连接到服务器的端口P的连接用来传送数据。
 ![image](https://user-images.githubusercontent.com/95112515/183558223-50d6acea-b27f-4d1e-8261-dc80507bfbce.png)
7、	多客户端传输
本实验采用多进程实现多客户端传输，当服务器控制进程接收到一个客户端connect请求时，在登录验证之后便创建新的进程，子进程负责处理客户端发来的命令和文件传输。同时父进程关闭连接，并继续开启监听套接字，以接收下一个连接。
8、额外功能
   ①创建文件夹：服务器在接收到请求后检查当前目录下文件夹是否存在，若不存在，则调用mkdir()函数创建文件夹，mkdir返回0代表创建成功，返回-1代表创建失败。将结果返回给客户端。
②删除文件：服务器接收到delete命令后，调用remove()函数删除文件，其中要先判断该文件是否存在于该文件夹下，不存在返回无法删除的信息，若存在，则根据delete后的文件名删除相应文件。
三、	实验结果 (其他实验结果略)
主动传输与被动传输：
通过记录每次创建连接和发起连接，可以反映控制连接记录和主被动的连接记录，pasv代表被动传输，port代表主动传输，nwebstarting代表控制连接。
 ![image](https://user-images.githubusercontent.com/95112515/183558346-b6293461-2558-46c2-8555-f4389bbcfdc9.png)
（服务器端记录，nweb是控制连接记录，pasv是被动连接记录，服务器监听1030 1032等等端口，每次有数据连接即随即监听的端口；port是主动连接的记录，）
![image](https://user-images.githubusercontent.com/95112515/183558358-3287fb73-7d7d-458e-87f4-66848f7a936b.png)
（客户端记录，被动模式客户端连接1030 1032等等端口，每次有数据连接即随即监听的端口；port是主动连接的记录，客户端负责建立连接和监听，客户端处显示的是进程号。）
